#!/usr/bin/env bash

while [[ $# -gt 0 ]]; do
    key="$1"

    case $key in
        -h|--help)
            echo "This script submits an L2G case to the ITER HPC."
            echo "Example:"
            echo "submitL2G l2g_case.json"
            echo "Available options (verbatim):"
            echo "partition=<partition_name> - Specify slurm partition name. No spaces between = operator"
            echo "cpus_per_task=<num_of_cpus> - Specify how many OpenMP threads you wish to use. No spaces between = operator.Default, maximum available"
            exit
            ;;
        partition=*)
            PARTITION_NAME=${1#*=}
            shift
            ;;
        cpus_per_task=*)
            CPUS_PER_TASK=${1#*=}
            shift
            ;;
        *.json) # L2G case file
            L2G_JSON=$1
            shift
            ;;
        *) # Unknown option
            shift
            ;;
    esac
done

SCRIPTPATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

# Extract the name of the case in JSON. But first we need to clean the JSON
# file
#               Remove //.* comments and trim trailing whitespaces
#                       |
#                       |                          Remove empty lines
#                       |                                |
#                       v                                v
JOB_NAME=$(sed 's/\/\/.*//g; s/ *$//' ${L2G_JSON} | sed '/^$/d ' - | python3 -c "import sys,json; print(json.load(sys.stdin)['name'])")

JOB_NAME=${JOB_NAME:-"L2G-job"}
LOG_NAME=${JOB_NAME}-slurm.log
# Defaults to gen10_ib
PARTITION_NAME=${PARTITION_NAME:-"gen10_ib"}

CPUS_PER_TASK=${CPUS_PER_TASK:-$(sinfo -p ${PARTITION_NAME} -O "cpus" --noheader)}
sbatch --job-name=${JOB_NAME} --output=${LOG_NAME} --partition=${PARTITION_NAME} --cpus-per-task=${CPUS_PER_TASK} --nodes=1 ${SCRIPTPATH}/L2G.sbatch "${L2G_JSON}"