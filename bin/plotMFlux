#!/usr/bin/env python3
import matplotlib.pyplot as plt
import matplotlib.colors as colors
import numpy as np

import os
import sys

import numpy as np
import l2g.external.equilibrium_analysis

import l2g.equil
import l2g.external.equilibrium_analysis
from l2g.plot._marching_squares import Marching, plot_paths

def plot_psi(ax, equilibrium: l2g.equil.Equilibrium) ->  None:
    """Plot the poloidal magnetic flux of an equilibrium to a matplotlib axes.
    """

    eq = l2g.external.equilibrium_analysis.EQA(equilibrium)
    eq.evaluate()

    m = Marching()
    m.setData(equilibrium.grid_r, equilibrium.grid_z, equilibrium.psi)

    psi_axis = equilibrium.psi_axis
    psi_boundary = eq.getBoundaryFluxValue()

    base_colormap = plt.get_cmap('jet_r')
    def truncate_colormap(cmap, minval=0.0, maxval=1.0, n=100):
        new_cmap = colors.LinearSegmentedColormap.from_list(
            f'trunc({cmap.name},{minval:.2f},{maxval:.2f})',
            cmap(np.linspace(minval, maxval, n)))
        return new_cmap
    colormap_vaccum = truncate_colormap(base_colormap, minval=0.8, maxval=1.0,
                                        n=10)
    colormap_drsep = truncate_colormap(base_colormap, minval=0.5, maxval=0.8,
                                       n=10)
    colormap_core = truncate_colormap(base_colormap, minval=0, maxval=0.3,
                                      n=25)

    eq_type = eq.getType()

    psi_outside = eq.getPsi(equilibrium.grid_r[-1],
                            eq.equilibrium.mag_axis_z)[0]

    R = equilibrium.grid_r
    Z = equilibrium.grid_z
    PSI = equilibrium.psi
    def contour_plot(cmap, psi1, psi2, N, a1, a2):
        band = np.linspace(psi1, psi2, N)
        ax.contour(R, Z, PSI, levels=band, cmap=cmap, alpha=a1)
        ax.contourf(R, Z, PSI, levels=band, cmap=cmap, alpha=a2)


    # Create intervals
    if eq_type == "div":
        # VACUUM
        psi_2nd_boundary = eq.getSecondaryXFluxValue()
        contour_plot(colormap_drsep, psi_boundary, psi_2nd_boundary, 10, 0.5, 0.2)
        contour_plot(colormap_vaccum, psi_2nd_boundary, psi_outside, 10, 0.3, 0.2)
    else:
        contour_plot(colormap_vaccum, psi_boundary, psi_outside, 10, 0.3, 0.2)

    contour_plot(colormap_core, psi_axis, psi_boundary, 25, 1, 0.2)

    # Plot first separatrix or LCFS

    boundary_path = m.getContourPath(psi_boundary)
    if eq_type == 'div':
        plot_paths(ax, boundary_path, label=r"$1^{st}$", color='g',
                   linewidth=1.5)
        secondary = m.getContourPath(psi_2nd_boundary)
        plot_paths(ax, secondary, label=r"$2^{nd}$", color='b', linewidth=1.5)
        # 4cm contour.
        Rbdry, Zcen, _, _ = eq.getMidplaneInfo()

        psi_dist4cm = eq.getPsi(Rbdry + 0.04, Zcen)[0]
        path_dist4cm = m.getContourPath(psi_dist4cm)
        plot_paths(ax, path_dist4cm, label=r"40 mm flux surface",
                   color='tab:orange', linewidth=1.5)
    else:
        plot_paths(ax, boundary_path, label=r"LCFS", color='g', linewidth=1.5)

    # Plot limiter silhouette
    ax.plot(eq.equilibrium.wall_contour_r, eq.equilibrium.wall_contour_z, 'r-', linewidth=2.5)
    ax.legend()

import argparse

from l2g import equil
description = """Plot magnetic poloidal flux from either an EQDSK-G file or
a time slice of the IMAS Equilibrium IDS.
"""

parser = argparse.ArgumentParser(description=description)
subparsers = parser.add_subparsers(dest="input_type", help="Data source: IMAS, EQDSK, ...")

imas_subparser = subparsers.add_parser("imas", help="Plot from IMAS source")
imas_subparser.add_argument('-s', '--shot', metavar='SHOT', type=int,
                    help='Shot number',
                    required=True)
imas_subparser.add_argument('-r', '--run', metavar='RUN', type=int,
                    help='Run number', required=True)
imas_subparser.add_argument('-u', '--user', metavar='USER', type=str, default="public",
                    help='Username')
imas_subparser.add_argument('-d', '--device',
                    metavar="DEVICE", type=str, default="ITER", help='Device')
imas_subparser.add_argument('-ts', '--time_slice', metavar='#time_slice', type=float,
                    default=0.0, help='Time slice')
imas_subparser.add_argument('-o', '--output_name', type=str, default="out",
                            help="Base name of files.", metavar="OUTNAME")

eqdsk_subparser = subparsers.add_parser("eqdsk", help="Plot from EQDSK source")
eqdsk_subparser.add_argument("eqdsk_file", nargs="?", help="Path to EQDSK file.")
eqdsk_subparser.add_argument('-o', '--output_name', type=str, default="out",
                             help="Base name of files.", metavar="OUTNAME")
imas_subparser.add_argument("-i", "--interactive", dest="interactive", action="store_true",
                    help="Display plots interactively")
eqdsk_subparser.add_argument("-i", "--interactive", dest="interactive", action="store_true",
                    help="Display plots interactively")


args = parser.parse_args()

eqIter = l2g.equil.EquilibriumIterator()

if args.input_type == "imas":
    d = {
        'user': args.user,
        'shot': args.shot,
        'run': args.run,
        'device': args.device,
        'times': [args.time_slice]}
    eqIter.loadIMASEquilibriums(d)
    title = f"S={args.shot} R={args.run} U={args.user} D={args.device} t={args.time_slice} s"
elif args.input_type == "eqdsk":
    import os
    if args.eqdsk_file is None or not os.access(args.eqdsk_file, os.R_OK | os.F_OK):
        print(f"Cannot access EQDSK file: {args.eqdsk_file}!")
        import sys
        sys.exit(1)
    eqIter.loadEqdskEquilibriums([args.eqdsk_file])
    title = os.path.basename(args.eqdsk_file)
else:
    print("Wrong input type specified")
    import sys
    sys.exit(1)

equilibrium = eqIter._equilibriums[0]

figure = plt.figure(figsize=(600/100, 800/100), dpi=100)
ax = figure.add_subplot(111)
ax.grid(True)
ax.axis("equal")
ax.set_xlabel('R [m]')
ax.set_ylabel('Z [m]')
# Plot wall
ax.plot(equilibrium.wall_contour_r, equilibrium.wall_contour_z, 'r-')
ax.set_title(title)

plot_psi(ax, equilibrium)

ax.set_ylim((np.min(equilibrium.wall_contour_z) -1), np.max(equilibrium.wall_contour_z) + 1)
ax.set_xlim((np.min(equilibrium.wall_contour_r) -1), np.max(equilibrium.wall_contour_r) + 1)

if args.interactive:
    plt.show()
else:
    print(f"Saving to {args.output_name}_psi.pdf")
    figure.savefig(f"{args.output_name}_psi.pdf")
    print(f"Saving to {args.output_name}_psi.png")
    figure.savefig(f"{args.output_name}_psi.png")
