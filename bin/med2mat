#!/usr/bin/env python3
# Converts fields of a MED file to MATLAB format.

import medcoupling as mc
from scipy.io import savemat

import sys
med_file = ''
if len(sys.argv) > 1:
    med_file = sys.argv[1]

if med_file == '':
    print("No MED file specified!")
    sys.exit(1)

# Get all fields
fieldNames = set(mc.GetAllFieldNames(med_file))
fields_to_ignore = ["vtkGhostType"]
for f in fields_to_ignore:
    if f in fieldNames:
        fieldNames.remove(f)

if not fieldNames:
    print(f"No fields in MED file {med_file}")
    sys.exit(1)

# Expect that each field has data at the same indexes
indexes = [(_[0], _[1]) for _ in mc.GetAllFieldIterations(med_file, next(iter(fieldNames)))]


for i in range(len(indexes)):
    mat_file = f"{med_file.split('.')[0]}_{i}_matlab.mat"
    out = {}

    for fieldName in fieldNames:
        field = mc.ReadField(med_file, fieldName, *indexes[i])
        array = field.getArray()
        out[fieldName] = array.toNumPyArray()

    # Save to matlab file
    savemat(mat_file, out)

