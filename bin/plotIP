#!/usr/bin/env python3

import argparse
description = """Plot Ip and Psol from the IMAS Summary IDS.
"""


parser = argparse.ArgumentParser(description=description)
parser.add_argument('-s', '--shot', metavar='SHOT', type=int,
                    help='Shot number',
                    required=True)
parser.add_argument('-r', '--run', metavar='RUN', type=int,
                    help='Run number', required=True)
parser.add_argument('-u', '--user', metavar='USER', type=str, default="public",
                    help='Username')
parser.add_argument('-d', '--device',
                    metavar="DEVICE", type=str, default="ITER", help='Device')
parser.add_argument('-ts', '--time_slice', metavar='#time_slice', type=float,
                    default=0.0, help='Time slice')
parser.add_argument('-o', '--output_name', type=str, default="out",
                            help="Base name of files.", metavar="OUTNAME")

args = parser.parse_args()

import numpy as np
import imas
import imas.imasdef
ids = imas.DBEntry(backend_id=imas.imasdef.MDSPLUS_BACKEND,
    user_name=args.user, db_name=args.device, shot=args.shot, run=args.run,
    data_version="3")
ids.open()
summary = ids.get("summary")

TITLE=f"s={args.shot} r={args.run}"

import matplotlib.pyplot as plt
import numpy as np

figure = plt.figure()
ax = figure.add_subplot(111)
ax.set_title(TITLE)
ax.grid(True)

lambdaq_vals = []
lambdaq_tims = []

time = summary.time


ip_vals = summary.global_quantities.ip.value
ip_vals = np.abs(np.asarray(ip_vals))
ax.plot(time, ip_vals*1e-6, color='r', label=r'$I_p$')

Psol = summary.global_quantities.power_loss.value
psol_vals = np.asarray(Psol)
title = r"$I_p$ [MA]"
if psol_vals.size == time.size:
    ax.plot(time, psol_vals*1e-6, color='g', label=r'$P_{sol}$')
    title += ", $P_{sol}$ [MW]"
else:
    # Let's plot Ohmic.
    p_ohm = summary.global_quantities.power_ohm.value
    if p_ohm.size == time.size:
        title += ", $P_{ohm}$ [MW]"
        ax.plot(time, p_ohm, color='g', label=r'$P_{ohm}$')

ax.set_ylabel('Ip [MA], Psol [MW]')
ax.set_xlabel('Time [s]')
ax.hlines(y=10, xmin=time[0], xmax=time[ip_vals <= 10e6][0], linewidth=2, color='r')
ax.legend()


plt.show()
